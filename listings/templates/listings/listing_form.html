{% extends 'base.html' %}
{% load static %}

{% block title %}
{% if form.instance.id %}Edit Listing: {{ form.instance.title }}{% else %}Create New Listing{% endif %} - Rental Aggregator
{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    #map {
        width: 100%;
        height: 400px;
        border: 1px solid #ddd;
        border-radius: 0.375rem;
    }
    .map-instructions {
        color: #6c757d;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h3 class="mb-0">{% if form.instance.id %}Edit Listing{% else %}Create New Listing{% endif %}</h3>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" id="listingForm">
                        {% csrf_token %}

                        {% if form.non_field_errors %}
                            <div class="alert alert-danger">
                                {% for error in form.non_field_errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}

                        <!-- Basic Information -->
                        <h5 class="mt-3 mb-3">Basic Information</h5>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.title.id_for_label }}" class="form-label">{{ form.title.label }}</label>
                                {{ form.title }}
                                {% if form.title.errors %}
                                    <div class="text-danger">{{ form.title.errors }}</div>
                                {% endif %}
                                <div class="form-text">Create a catchy title that highlights your property's best features.</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="text-danger">{{ form.description.errors }}</div>
                                {% endif %}
                                <div class="form-text">Describe your property in detail. Include unique features and attractions nearby.</div>
                            </div>
                        </div>

                        <!-- Location -->
                        <h5 class="mt-4 mb-3">Location</h5>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.address.id_for_label }}" class="form-label">{{ form.address.label }}</label>
                                {{ form.address }}
                                {% if form.address.errors %}
                                    <div class="text-danger">{{ form.address.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.city.id_for_label }}" class="form-label">{{ form.city.label }}</label>
                                {{ form.city }}
                                {% if form.city.errors %}
                                    <div class="text-danger">{{ form.city.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.state.id_for_label }}" class="form-label">{{ form.state.label }}</label>
                                {{ form.state }}
                                {% if form.state.errors %}
                                    <div class="text-danger">{{ form.state.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.country.id_for_label }}" class="form-label">{{ form.country.label }}</label>
                                {{ form.country }}
                                {% if form.country.errors %}
                                    <div class="text-danger">{{ form.country.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.zip_code.id_for_label }}" class="form-label">{{ form.zip_code.label }}</label>
                                {{ form.zip_code }}
                                {% if form.zip_code.errors %}
                                    <div class="text-danger">{{ form.zip_code.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Map Section -->
                        <div class="mb-3">
                            <label class="form-label">Property Location</label>
                            <div class="map-instructions">
                                Click on the map to set the exact location of your property, or use the search box to find an address.
                            </div>
                            <div class="mb-2">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="geocodeAddress()">
                                    <i class="fas fa-search"></i> Find Address on Map
                                </button>
                            </div>
                            <div id="map"></div>
                            {{ form.latitude }}
                            {{ form.longitude }}
                        </div>

                        <!-- Property Details -->
                        <h5 class="mt-4 mb-3">Property Details</h5>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.property_type.id_for_label }}" class="form-label">{{ form.property_type.label }}</label>
                                {{ form.property_type }}
                                {% if form.property_type.errors %}
                                    <div class="text-danger">{{ form.property_type.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.accommodates.id_for_label }}" class="form-label">{{ form.accommodates.label }}</label>
                                {{ form.accommodates }}
                                {% if form.accommodates.errors %}
                                    <div class="text-danger">{{ form.accommodates.errors }}</div>
                                {% endif %}
                                <div class="form-text">Maximum number of guests allowed.</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.bedrooms.id_for_label }}" class="form-label">{{ form.bedrooms.label }}</label>
                                {{ form.bedrooms }}
                                {% if form.bedrooms.errors %}
                                    <div class="text-danger">{{ form.bedrooms.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.bathrooms.id_for_label }}" class="form-label">{{ form.bathrooms.label }}</label>
                                {{ form.bathrooms }}
                                {% if form.bathrooms.errors %}
                                    <div class="text-danger">{{ form.bathrooms.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Amenities -->
                        <h5 class="mt-4 mb-3">Amenities</h5>
                        <div class="mb-4">
                            {{ form.amenities }}
                            <div id="amenities-container" class="mt-2">
                                <!-- Amenity chips will be added here -->
                            </div>
                            {% if form.amenities.errors %}
                                <div class="text-danger">{{ form.amenities.errors }}</div>
                            {% endif %}
                        </div>

                        <!-- Pricing -->
                        <h5 class="mt-4 mb-3">Pricing</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.price_per_night.id_for_label }}" class="form-label">{{ form.price_per_night.label }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.price_per_night }}
                                </div>
                                {% if form.price_per_night.errors %}
                                    <div class="text-danger">{{ form.price_per_night.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.cleaning_fee.id_for_label }}" class="form-label">{{ form.cleaning_fee.label }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.cleaning_fee }}
                                </div>
                                {% if form.cleaning_fee.errors %}
                                    <div class="text-danger">{{ form.cleaning_fee.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.service_fee.id_for_label }}" class="form-label">{{ form.service_fee.label }}</label>
                                <div class="input-group">
                                    <span class="input-group-text">$</span>
                                    {{ form.service_fee }}
                                </div>
                                {% if form.service_fee.errors %}
                                    <div class="text-danger">{{ form.service_fee.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Rules and Availability -->
                        <h5 class="mt-4 mb-3">Rules and Availability</h5>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="{{ form.house_rules.id_for_label }}" class="form-label">{{ form.house_rules.label }}</label>
                                {{ form.house_rules }}
                                {% if form.house_rules.errors %}
                                    <div class="text-danger">{{ form.house_rules.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.check_in_time.id_for_label }}" class="form-label">{{ form.check_in_time.label }}</label>
                                {{ form.check_in_time }}
                                {% if form.check_in_time.errors %}
                                    <div class="text-danger">{{ form.check_in_time.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.check_out_time.id_for_label }}" class="form-label">{{ form.check_out_time.label }}</label>
                                {{ form.check_out_time }}
                                {% if form.check_out_time.errors %}
                                    <div class="text-danger">{{ form.check_out_time.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.minimum_nights.id_for_label }}" class="form-label">{{ form.minimum_nights.label }}</label>
                                {{ form.minimum_nights }}
                                {% if form.minimum_nights.errors %}
                                    <div class="text-danger">{{ form.minimum_nights.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.maximum_nights.id_for_label }}" class="form-label">{{ form.maximum_nights.label }}</label>
                                {{ form.maximum_nights }}
                                {% if form.maximum_nights.errors %}
                                    <div class="text-danger">{{ form.maximum_nights.errors }}</div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="{% if form.instance.id %}{% url 'listings:listing_detail' pk=form.instance.id %}{% else %}{% url 'listings:host_listings' %}{% endif %}" class="btn btn-outline-secondary me-md-2">Cancel</a>
                            <button type="submit" class="btn btn-primary">Save Listing</button>
                        </div>
                    </form>
                </div>
            </div>

            {% if form.instance.id %}
            <div class="card shadow-sm mt-4">
                <div class="card-header bg-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Manage Images</h5>
                    <a href="{% url 'listings:listing_images' pk=form.instance.id %}" class="btn btn-sm btn-outline-primary">
                        <i class="fas fa-images me-1"></i> Edit Images
                    </a>
                </div>
                <div class="card-body">
                    {% if form.instance.image_urls %}
                        <div class="row row-cols-1 row-cols-md-3 g-3">
                            {% for image_url in form.instance.image_urls %}
                            <div class="col">
                                <img src="{{ image_url }}" class="img-thumbnail" alt="Listing image">
                            </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-muted">No images have been added yet. Click 'Edit Images' to add some.</p>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://api-maps.yandex.ru/2.1/?apikey=&lang=en_US" type="text/javascript"></script>
<script src="{% static 'listings/js/yandex_maps.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Get initial coordinates if editing
    const latField = document.getElementById('id_latitude');
    const lngField = document.getElementById('id_longitude');

    let initialLat = 55.751244; // Moscow default
    let initialLng = 37.618423;

    if (latField.value && lngField.value) {
        initialLat = parseFloat(latField.value);
        initialLng = parseFloat(lngField.value);
    }

    // Initialize map
    initYandexMap('map', initialLat, initialLng, true);
});
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Amenities selection
        const amenitiesInput = document.getElementById('{{ form.amenities.id_for_label }}');
        const amenitiesContainer = document.getElementById('amenities-container');

        // Common amenities
        const commonAmenities = [
            'Wifi', 'Kitchen', 'Free parking', 'Air conditioning', 'Heating', 'TV',
            'Washer', 'Dryer', 'Iron', 'Hair dryer', 'Pool', 'Hot tub', 'Gym',
            'Elevator', 'Wheelchair accessible', 'BBQ grill', 'Balcony', 'Garden view',
            'Sea view', 'Mountain view', 'Smoke alarm', 'Carbon monoxide alarm',
            'Essentials', 'Cable TV', 'Breakfast', 'Pets allowed'
        ];

        // Get existing amenities, if any
        let selectedAmenities = [];
        if (amenitiesInput.value) {
            try {
                selectedAmenities = JSON.parse(amenitiesInput.value);
            } catch (e) {
                console.error('Error parsing amenities:', e);
                selectedAmenities = [];
            }
        }

        // Create amenity chips
        commonAmenities.forEach(amenity => {
            const chip = document.createElement('span');
            chip.className = 'amenity-chip';
            chip.innerText = amenity;

            // Check if amenity is already selected
            if (selectedAmenities.includes(amenity)) {
                chip.classList.add('selected');
            }

            chip.addEventListener('click', function() {
                this.classList.toggle('selected');
                updateAmenitiesInput();
            });

            amenitiesContainer.appendChild(chip);
        });

        // Function to update the hidden input with selected amenities
        function updateAmenitiesInput() {
            const selectedChips = amenitiesContainer.querySelectorAll('.amenity-chip.selected');
            const selectedValues = Array.from(selectedChips).map(chip => chip.innerText);
            amenitiesInput.value = JSON.stringify(selectedValues);
        }
    });
</script>
{% endblock %}