{% load listing_extras %}

<div x-data="calendar()" x-init="init()" class="listing-calendar">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="btn-group">
            <button type="button" class="btn btn-outline-secondary" x-on:click="previousMonth()">
                <i class="fas fa-chevron-left"></i> Previous
            </button>
            <button type="button" class="btn btn-outline-secondary" x-on:click="nextMonth()">
                Next <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        <h5 class="mb-0" x-text="currentMonthName + ' ' + currentYear"></h5>
    </div>

    <div class="calendar-container">
        <table class="calendar-table">
            <thead>
                <tr>
                    <th>Su</th>
                    <th>Mo</th>
                    <th>Tu</th>
                    <th>We</th>
                    <th>Th</th>
                    <th>Fr</th>
                    <th>Sa</th>
                </tr>
            </thead>
            <tbody>
                <template x-for="(week, weekIndex) in calendarDays" :key="weekIndex">
                    <tr>
                        <template x-for="(day, dayIndex) in week" :key="weekIndex + '-' + dayIndex">
                            <td :class="{ 'empty': !day.date }">
                                <div 
                                    class="calendar-day" 
                                    :class="{
                                        'unavailable': day.isUnavailable,
                                        'today': day.isToday,
                                        'empty': !day.date
                                    }"
                                    x-on:click="selectDate(day.date)"
                                >
                                    <div class="day-content" x-text="day.dayNumber"></div>
                                </div>
                            </td>
                        </template>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Legend -->
    <div class="d-flex justify-content-center mt-3 gap-3">
        <div class="legend-item">
            <div class="legend-box" style="background-color: #e74c3c;"></div>
            <span class="legend-text">Unavailable</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background-color: #3498db;"></div>
            <span class="legend-text">Today</span>
        </div>
        <div class="legend-item">
            <div class="legend-box" style="background-color: #f8f9fa; border: 1px solid #dee2e6;"></div>
            <span class="legend-text">Available</span>
        </div>
    </div>
</div>

<script>
// Make unavailable dates available globally for calendar initialization
window.unavailableDatesJson = '{{ unavailable_dates_json|safe }}';

function calendar() {
    return {
        currentYear: new Date().getFullYear(),
        currentMonth: new Date().getMonth(),
        calendarDays: [],
        startDate: null,
        endDate: null,
        selectionMode: 'start', // 'start' or 'end'
        unavailableDates: [], // Initialize as empty array
        
        init() {
            console.log('Calendar component initialized');

            // Parse the JSON string into an object
            try {
                this.unavailableDates = JSON.parse(window.unavailableDatesJson.replace(/&quot;/g, '"')) || [];
            } catch (e) {
                console.error("Error parsing unavailable dates JSON:", e);
                this.unavailableDates = [];
            }
            this.generateCalendar();
            
            // Get query params
            const urlParams = new URLSearchParams(window.location.search);
            const checkIn = urlParams.get('check_in');
            const checkOut = urlParams.get('check_out');
            
            // Set dates from URL if available
            if (checkIn) {
                this.startDate = checkIn;
                this.selectionMode = 'end';
            }
            if (checkOut) {
                this.endDate = checkOut;
                this.selectionMode = 'start';
            }
            
            // Listen for date selection from inputs
            const checkInInput = document.getElementById('check_in');
            const checkOutInput = document.getElementById('check_out');
            
            if (checkInInput) {
                checkInInput.addEventListener('change', (event) => {
                    this.startDate = event.target.value;
                    this.selectionMode = 'end';
                    this.generateCalendar();
                });
            }
            
            if (checkOutInput) {
                checkOutInput.addEventListener('change', (event) => {
                    this.endDate = event.target.value;
                    this.selectionMode = 'start';
                    this.generateCalendar();
                });
            }
        },
        
        get currentMonthName() {
            return new Date(this.currentYear, this.currentMonth).toLocaleString('default', { month: 'long' });
        },
        
        generateCalendar() {
            const firstDay = new Date(this.currentYear, this.currentMonth, 1).getDay();
            const daysInMonth = new Date(this.currentYear, this.currentMonth + 1, 0).getDate();
            
            const calendar = [];
            let date = 1;
            
            // Create weeks
            for (let i = 0; i < 6; i++) {
                const week = [];
                
                // Create days in week
                for (let j = 0; j < 7; j++) {
                    if (i === 0 && j < firstDay) {
                        // Empty cells before first day
                        week.push({ date: null, isUnavailable: false });
                    } else if (date > daysInMonth) {
                        // Empty cells after last day
                        week.push({ date: null, isUnavailable: false });
                    } else {
                        // Valid days
                        const currentDate = new Date(this.currentYear, this.currentMonth, date);
                        const dateStr = this.formatDate(currentDate);
                        const isToday = this.isToday(dateStr);
                        const isUnavailable = this.isUnavailable(dateStr);

                        week.push({
                            date: dateStr,
                            dayNumber: date,
                            isToday: isToday,
                            isUnavailable: isUnavailable
                        });
                        
                        date++;
                    }
                }
                
                calendar.push(week);
                
                // Stop if we've reached the end of the month
                if (date > daysInMonth) {
                    break;
                }
            }
            
            this.calendarDays = calendar;
        },
        
        previousMonth() {
            if (this.currentMonth === 0) {
                this.currentYear--;
                this.currentMonth = 11;
            } else {
                this.currentMonth--;
            }
            this.generateCalendar();
        },
        
        nextMonth() {
            if (this.currentMonth === 11) {
                this.currentYear++;
                this.currentMonth = 0;
            } else {
                this.currentMonth++;
            }
            this.generateCalendar();
        },
        
        selectDate(dateStr) {
            if (!dateStr || this.isUnavailable(dateStr)) return;
            
            if (this.selectionMode === 'start') {
                this.startDate = dateStr;
                this.endDate = null;
                this.selectionMode = 'end';
                
                // Update check-in input if it exists
                const checkInInput = document.getElementById('check_in');
                if (checkInInput) {
                    checkInInput.value = dateStr;
                    checkInInput.dispatchEvent(new Event('change'));
                }
            } else {
                // Ensure end date is after start date
                if (dateStr <= this.startDate) {
                    this.startDate = dateStr;
                    this.endDate = null;
                    
                    // Update check-in input if it exists
                    const checkInInput = document.getElementById('check_in');
                    if (checkInInput) {
                        checkInInput.value = dateStr;
                        checkInInput.dispatchEvent(new Event('change'));
                    }
                    return;
                }
                
                // Check if any unavailable dates are in range
                if (this.hasUnavailableDateInRange(this.startDate, dateStr)) {
                    alert('Your selected date range includes unavailable dates. Please choose another range.');
                    return;
                }
                
                this.endDate = dateStr;
                this.selectionMode = 'start';
                
                // Update check-out input if it exists
                const checkOutInput = document.getElementById('check_out');
                if (checkOutInput) {
                    checkOutInput.value = dateStr;
                    checkOutInput.dispatchEvent(new Event('change'));
                }
            }
            
            this.generateCalendar();
        },
        
        formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        },
        
        isToday(dateStr) {
            const today = this.formatDate(new Date());
            return dateStr === today;
        },
        
        isUnavailable(dateStr) {
            // Check if date is in the past
            const today = this.formatDate(new Date());
            if (dateStr < today) return true;
            
            // Check if date is in unavailable dates
            return this.unavailableDates.includes(dateStr);
        },
        
        hasUnavailableDateInRange(start, end) {
            // Convert to Date objects
            const startDate = new Date(start);
            const endDate = new Date(end);
            
            // Check each date in range (excluding end date)
            for (let d = new Date(startDate); d < endDate; d.setDate(d.getDate() + 1)) {
                const dateStr = this.formatDate(d);
                if (this.unavailableDates.includes(dateStr)) {
                    return true;
                }
            }
            
            return false;
        },
        
        isSelected(dateStr) {
            return dateStr === this.startDate || dateStr === this.endDate;
        },
        
        isStartDate(dateStr) {
            return dateStr === this.startDate;
        },
        
        isEndDate(dateStr) {
            return dateStr === this.endDate;
        },
        
        isInRange(dateStr) {
            if (!this.startDate || !this.endDate) return false;
            return dateStr > this.startDate && dateStr < this.endDate;
        }
    };
}
</script>