
{% extends 'base.html' %}
{% load i18n %}

{% block title %}Управление подписками - Администратор{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <h1><i class="fas fa-chart-bar"></i> Управление подписками</h1>
            <p class="text-muted">Административная панель для управления подписками пользователей</p>
        </div>
    </div>

    <!-- Статистика -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h5 class="card-title">Всего подписок</h5>
                    <h2 id="total-subscriptions">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body">
                    <h5 class="card-title">Активных</h5>
                    <h2 id="active-subscriptions">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-white">
                <div class="card-body">
                    <h5 class="card-title">Истекающих</h5>
                    <h2 id="expiring-subscriptions">-</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body">
                    <h5 class="card-title">Доход</h5>
                    <h2 id="total-revenue">-</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Быстрые действия -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Быстрые действия</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <a href="{% url 'admin:subscriptions_subscriptionplan_changelist' %}" class="btn btn-primary w-100">
                                <i class="fas fa-cog"></i> Управление планами
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{% url 'admin:subscriptions_usersubscription_changelist' %}" class="btn btn-info w-100">
                                <i class="fas fa-users"></i> Все подписки
                            </a>
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-success w-100" onclick="showCreateSubscriptionModal()">
                                <i class="fas fa-plus"></i> Создать подписку
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Последние подписки -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5>Последние подписки</h5>
                </div>
                <div class="card-body">
                    <div id="recent-subscriptions">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">Загрузка...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal создания подписки -->
<div class="modal fade" id="createSubscriptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Создать подписку для пользователя</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createSubscriptionForm">
                    <div class="mb-3">
                        <label class="form-label">ID пользователя</label>
                        <input type="number" class="form-control" id="userId" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">План подписки</label>
                        <select class="form-control" id="planId" required>
                            <option value="">Выберите план...</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="autoRenew">
                        <label class="form-check-label">
                            Автоматическое продление
                        </label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="createSubscription()">
                    Создать подписку
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Загрузка статистики
function loadStats() {
    fetch('/api/subscriptions/admin/stats/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('total-subscriptions').textContent = data.total_subscriptions || 0;
            document.getElementById('active-subscriptions').textContent = data.active_subscriptions || 0;
            document.getElementById('expiring-subscriptions').textContent = data.expiring_soon || 0;
            document.getElementById('total-revenue').textContent = '$' + (data.total_revenue || 0);
        })
        .catch(error => {
            console.error('Ошибка загрузки статистики:', error);
        });
}

// Загрузка планов для модала
function loadPlans() {
    fetch('/api/subscriptions/plans/')
        .then(response => response.json())
        .then(data => {
            const select = document.getElementById('planId');
            select.innerHTML = '<option value="">Выберите план...</option>';
            data.forEach(plan => {
                select.innerHTML += `<option value="${plan.id}">${plan.name} - $${plan.price}</option>`;
            });
        });
}

// Загрузка последних подписок
function loadRecentSubscriptions() {
    fetch('/api/subscriptions/')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('recent-subscriptions');
            if (data.results && data.results.length > 0) {
                container.innerHTML = data.results.slice(0, 10).map(sub => `
                    <div class="border-bottom py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>Пользователь ID: ${sub.user}</strong> - ${sub.plan_name}
                                <br>
                                <small class="text-muted">
                                    Статус: <span class="badge ${getStatusBadgeClass(sub.status)}">${getStatusText(sub.status)}</span>
                                    | Создано: ${new Date(sub.created_at).toLocaleDateString()}
                                </small>
                            </div>
                            <div>
                                <button class="btn btn-sm btn-outline-primary" onclick="extendSubscription(${sub.id})">
                                    Продлить
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                container.innerHTML = '<p class="text-muted">Нет подписок для отображения</p>';
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки подписок:', error);
            document.getElementById('recent-subscriptions').innerHTML = '<p class="text-danger">Ошибка загрузки данных</p>';
        });
}

function getStatusBadgeClass(status) {
    const classes = {
        'active': 'bg-success',
        'expired': 'bg-danger',
        'canceled': 'bg-secondary',
        'pending': 'bg-warning'
    };
    return classes[status] || 'bg-secondary';
}

function getStatusText(status) {
    const texts = {
        'active': 'Активная',
        'expired': 'Истекшая',
        'canceled': 'Отменена',
        'pending': 'Ожидание'
    };
    return texts[status] || status;
}

function showCreateSubscriptionModal() {
    loadPlans();
    const modal = new bootstrap.Modal(document.getElementById('createSubscriptionModal'));
    modal.show();
}

function createSubscription() {
    const userId = document.getElementById('userId').value;
    const planId = document.getElementById('planId').value;
    const autoRenew = document.getElementById('autoRenew').checked;
    
    if (!userId || !planId) {
        alert('Заполните все обязательные поля');
        return;
    }
    
    fetch(`/api/subscriptions/admin/create/${userId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            plan_id: planId,
            auto_renew: autoRenew
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Подписка успешно создана!');
            loadStats();
            loadRecentSubscriptions();
            const modal = bootstrap.Modal.getInstance(document.getElementById('createSubscriptionModal'));
            modal.hide();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при создании подписки');
    });
}

function extendSubscription(subscriptionId) {
    const days = prompt('На сколько дней продлить подписку?', '30');
    if (!days || isNaN(days)) return;
    
    fetch(`/api/subscriptions/admin/extend/${subscriptionId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            days: parseInt(days)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Подписка продлена на ' + days + ' дней');
            loadRecentSubscriptions();
        } else {
            alert('Ошибка: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Ошибка:', error);
        alert('Произошла ошибка при продлении подписки');
    });
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadRecentSubscriptions();
});
</script>

{% csrf_token %}
{% endblock %}
