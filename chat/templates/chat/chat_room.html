{% extends 'base.html' %}
{% load static %}

{% block title %}Chat with {{ other_participants.first.username }} - Rental Aggregator{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <!-- Sidebar with conversation list -->
        <div class="col-lg-3 mb-4 mb-lg-0">
            <div class="card shadow-sm">
                <div class="card-body p-0">
                    <div class="p-3 border-bottom">
                        <h5 class="mb-0">Messages</h5>
                    </div>
                    
                    <div class="conversation-list" style="max-height: 70vh; overflow-y: auto;">
                        {% for conv in request.user.conversations.all %}
                        <a href="{% url 'chat:conversation_detail' pk=conv.id %}" 
                           class="conversation-item d-flex align-items-center text-decoration-none text-reset p-3 border-bottom {% if conv.id == conversation.id %}bg-light{% endif %}">
                            {% with other_user=conv.participants.exclude.id=request.user.id.first %}
                                {% if other_user.profile_picture %}
                                    <img src="{{ other_user.profile_picture }}" class="rounded-circle me-3" width="40" height="40" alt="{{ other_user.username }}">
                                {% else %}
                                    <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-3 text-white" style="width: 40px; height: 40px;">
                                        {{ other_user.username|first|upper }}
                                    </div>
                                {% endif %}
                            {% endwith %}
                            
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 text-truncate" style="max-width: 120px;">
                                        {% for participant in conv.participants.all %}
                                            {% if participant != request.user %}
                                                {{ participant.username }}
                                            {% endif %}
                                        {% endfor %}
                                    </h6>
                                    <small class="text-muted">{{ conv.updated_at|date:"M d" }}</small>
                                </div>
                                <p class="mb-0 small text-muted text-truncate">
                                    {% if conv.last_message %}
                                        {% if conv.last_message.sender == request.user %}You: {% endif %}
                                        {{ conv.last_message.content|truncatechars:30 }}
                                    {% else %}
                                        No messages yet
                                    {% endif %}
                                </p>
                            </div>
                        </a>
                        {% empty %}
                        <div class="p-4 text-center text-muted">
                            <p>No conversations yet</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Main chat area -->
        <div class="col-lg-9">
            <div class="card shadow-sm">
                <!-- Chat header -->
                <div class="card-header bg-white p-3 border-bottom">
                    <div class="d-flex align-items-center">
                        {% with other_user=other_participants.first %}
                            {% if other_user.profile_picture %}
                                <img src="{{ other_user.profile_picture }}" class="rounded-circle me-3" width="40" height="40" alt="{{ other_user.username }}">
                            {% else %}
                                <div class="rounded-circle bg-primary d-flex align-items-center justify-content-center me-3 text-white" style="width: 40px; height: 40px;">
                                    {{ other_user.username|first|upper }}
                                </div>
                            {% endif %}
                            
                            <div>
                                <h5 class="mb-0">{{ other_user.get_full_name|default:other_user.username }}</h5>
                                {% if conversation.listing or conversation.booking %}
                                    <p class="text-muted mb-0 small">
                                        {% if conversation.listing %}
                                            About: {{ conversation.listing.title }}
                                        {% elif conversation.booking %}
                                            Booking: {{ conversation.booking.listing.title }}
                                        {% endif %}
                                    </p>
                                {% endif %}
                            </div>
                        {% endwith %}
                        
                        <div class="dropdown ms-auto">
                            <button class="btn btn-outline-secondary btn-sm" type="button" id="chatOptionsDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-ellipsis-v"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="chatOptionsDropdown">
                                {% if conversation.listing %}
                                    <li>
                                        <a class="dropdown-item" href="{% url 'listings:listing_detail' pk=conversation.listing.id %}">
                                            <i class="fas fa-home me-2"></i> View Listing
                                        </a>
                                    </li>
                                {% endif %}
                                {% if conversation.booking %}
                                    <li>
                                        <a class="dropdown-item" href="{% url 'listings:booking_detail' reference=conversation.booking.booking_reference %}">
                                            <i class="fas fa-calendar-check me-2"></i> View Booking
                                        </a>
                                    </li>
                                {% endif %}
                                <li>
                                    <a class="dropdown-item" href="#" data-bs-toggle="modal" data-bs-target="#reportModal">
                                        <i class="fas fa-flag me-2"></i> Report
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Chat messages area -->
                <div class="card-body p-3" style="height: 60vh; overflow-y: auto;" id="chat-messages">
                    {% if messages %}
                        {% for message in messages %}
                            {% include 'chat/_message.html' with message=message %}
                        {% endfor %}
                    {% else %}
                        <div class="text-center py-5 my-5">
                            <div class="mb-3">
                                <i class="fas fa-comments fa-3x text-muted"></i>
                            </div>
                            <h5>Start a conversation</h5>
                            <p class="text-muted">Say hello or ask questions about the property</p>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Chat input area -->
                <div class="card-footer bg-white p-3 border-top">
                    <form id="chat-form" class="d-flex">
                        <input type="text" class="form-control me-2" id="message-input" placeholder="Type a message..." autocomplete="off">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Report Modal -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel">Report Conversation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form action="{% url 'moderation:report_content' content_type='message' content_id=0 %}" method="post" id="report-form">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="report-reason" class="form-label">Reason for reporting</label>
                        <select class="form-select" id="report-reason" name="category" required>
                            <option value="">Select a reason</option>
                            <option value="1">Inappropriate content</option>
                            <option value="2">Harassment</option>
                            <option value="3">Spam</option>
                            <option value="4">Scam attempt</option>
                            <option value="5">Other</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="report-description" class="form-label">Description</label>
                        <textarea class="form-control" id="report-description" name="description" rows="3" required></textarea>
                        <div class="form-text">Please provide details about the issue.</div>
                    </div>
                    <input type="hidden" name="message_id" id="reported-message-id" value="">
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="submitReport()">Submit Report</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'chat/js/chat.js' %}"></script>
<script>
    // Chat connection setup
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize the WebSocket connection
        initChatSocket('{{ conversation.id }}', '{{ request.user.id }}');
        
        // Scroll to the bottom of the chat on load
        scrollToBottom();
        
        // Handle message submission
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (message) {
                // Send the message through WebSocket
                sendMessage(message);
                
                // Clear the input
                messageInput.value = '';
            }
        });
    });
    
    // Scroll chat to bottom
    function scrollToBottom() {
        const chatMessages = document.getElementById('chat-messages');
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Report message functionality
    function reportMessage(messageId) {
        document.getElementById('reported-message-id').value = messageId;
        const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
        reportModal.show();
    }
    
    function submitReport() {
        const messageId = document.getElementById('reported-message-id').value;
        const form = document.getElementById('report-form');
        
        // Update the form action with the correct message ID
        const actionUrl = form.action.replace('/0/', `/${messageId}/`);
        form.action = actionUrl;
        
        // Submit the form
        form.submit();
    }
</script>
{% endblock %}
